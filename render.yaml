from typing import Optional
# ...

def require_key(x_api_key: Optional[str]):
    if not APP_KEY:
        raise HTTPException(500, "Server misconfigured: APP_KEY missing")
    if not x_api_key or x_api_key != APP_KEY:
        raise HTTPException(401, "Unauthorized")

@app.get("/fetch")
def fetch(url: str, x_api_key: Optional[str] = Header(default=None, alias="X-API-Key")):
    require_key(x_api_key)
    # le reste inchang√©